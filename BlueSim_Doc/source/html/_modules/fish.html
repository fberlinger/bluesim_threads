
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>fish &#8212; BlueSim 0.0.1 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">BlueSim 0.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for fish</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="k">import</span> <span class="n">Queue</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">from</span> <span class="nn">events</span> <span class="k">import</span> <span class="n">HopCount</span><span class="p">,</span> <span class="n">Ping</span><span class="p">,</span> <span class="n">InfoInternal</span><span class="p">,</span> <span class="n">LeaderElection</span>
<span class="kn">from</span> <span class="nn">eventcodes</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">PING</span><span class="p">,</span> <span class="n">HOMING</span><span class="p">,</span> <span class="n">HOP_COUNT</span><span class="p">,</span> <span class="n">INFO_EXTERNAL</span><span class="p">,</span> <span class="n">INFO_INTERNAL</span><span class="p">,</span> <span class="n">START_HOP_COUNT</span><span class="p">,</span>
    <span class="n">START_LEADER_ELECTION</span><span class="p">,</span> <span class="n">LEADER_ELECTION</span><span class="p">,</span> <span class="n">MOVE</span>
<span class="p">)</span>


<div class="viewcode-block" id="Fish"><a class="viewcode-back" href="../index.html#fish.Fish">[docs]</a><span class="k">class</span> <span class="nc">Fish</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;This class models each fish robot node in the collective from the fish&#39;</span>
<span class="sd">    perspective.</span>

<span class="sd">    Each fish has an ID, communicates over the channel, and perceives its</span>
<span class="sd">    neighbors and takes actions accordingly. In taking actions, the fish can</span>
<span class="sd">    weight information from neighbors based on their distance. Different collective behaviors run different methods of this class. It can perceive and move according to its perceptual and dynamics model, and updates its behavior on every clock tick.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        behavior (str): Behavior that fish follows</span>
<span class="sd">        body_length (int): Length of a BlueBot (130mm)</span>
<span class="sd">        caudal (int): Caudal fin control</span>
<span class="sd">        channel (Class): Communication channel</span>
<span class="sd">        clock (int): Local clock time</span>
<span class="sd">        clock_freq (float): Clock speed (Hz)</span>
<span class="sd">        clock_speed (float): Clock speed (s)</span>
<span class="sd">        d_center (int): Relative distance to center of perceived neighbors</span>
<span class="sd">        dorsal (int): Dorsal fin control</span>
<span class="sd">        dynamics (Class): Fish dynamics model</span>
<span class="sd">        fish_max_speed (int): Maximum forward speed of fish (old simulator)</span>
<span class="sd">        hop_count (int): Hop count variable</span>
<span class="sd">        hop_count_initiator (bool): Hop count started or not</span>
<span class="sd">        hop_distance (int): Hop distance to other fish</span>
<span class="sd">        id (int): ID number of fish</span>
<span class="sd">        info (str): Some information</span>
<span class="sd">        info_clock (int): Time stamp of the information, i.e., the clock</span>
<span class="sd">        info_hops (int): Number of hops until the information arrived</span>
<span class="sd">        initial_hop_count_clock (int): Hop count start time</span>
<span class="sd">        interaction (Class): Class for interactions between fish</span>
<span class="sd">        is_started (bool): True/false</span>
<span class="sd">        last_hop_count_clock (TYPE): Time since last hop count</span>
<span class="sd">        last_leader_election_clock (int): Time since last leader election</span>
<span class="sd">        leader_election_max_id (int): Highest ID</span>
<span class="sd">        lim_neighbors (int): Max. and min. desired number of neighbors</span>
<span class="sd">        messages (list): Messages between fish</span>
<span class="sd">        name (string): Name for logger file</span>
<span class="sd">        neighbor_weight (float): Gain that influeces decision making</span>
<span class="sd">        neighbors (set): Set of observed neighboring fish</span>
<span class="sd">        pect_l (int): Pectoral left fin control</span>
<span class="sd">        pect_r (int): Pectoral right fin control</span>
<span class="sd">        queue (TYPE): Message queue for messages from neighbors</span>
<span class="sd">        saw_hop_count (bool): True/false</span>
<span class="sd">        status (str): Behavioral status</span>
<span class="sd">        target_depth (int): Target depth for diving</span>
<span class="sd">        target_dist (int): Target distance for orbiting</span>
<span class="sd">        target_pos (int): Target position instructed by observer</span>
<span class="sd">        verbose (bool): Print statements on/off</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">,</span>
        <span class="n">channel</span><span class="p">,</span>
        <span class="n">interaction</span><span class="p">,</span>
        <span class="n">dynamics</span><span class="p">,</span>
        <span class="n">target_dist</span><span class="o">=</span><span class="mi">390</span><span class="p">,</span>
        <span class="n">lim_neighbors</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span>
        <span class="n">fish_max_speed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">clock_freq</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">neighbor_weight</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Unnamed&#39;</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new fish</span>

<span class="sd">        Arguments:</span>
<span class="sd">            id (TYPE): UUID of fish</span>
<span class="sd">            channel (Class): Communication channel</span>
<span class="sd">            interaction (Class): Class for interactions between fish</span>
<span class="sd">            dynamics (Class): Fish dynamics model</span>
<span class="sd">            target_dist (int, optional): target_distance to neighbors</span>
<span class="sd">            lim_neighbors (int, int): Lower and upper limit of neighbors each</span>
<span class="sd">                fish aims to be connected to.</span>
<span class="sd">                (default: {0, math.inf})</span>
<span class="sd">            fish_max_speed (float): Max speed of each fish. Defines by how</span>
<span class="sd">                much it can change its position in one simulation step.</span>
<span class="sd">                (default: {1})</span>
<span class="sd">            clock_freq (number): Behavior update rate in Hertz (default: {1})</span>
<span class="sd">            neighbor_weight (number): A weight based on distance that defines</span>
<span class="sd">                how much each of a fish&#39;s neighbor affects its next move.</span>
<span class="sd">                (default: {1.0})</span>
<span class="sd">            name (str): Unique name of the fish. (default: {&#39;Unnamed&#39;})</span>
<span class="sd">            verbose (bool): If `true` log out some stuff (default: {False})</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span> <span class="o">=</span> <span class="n">interaction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span> <span class="o">=</span> <span class="n">dynamics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_dist</span> <span class="o">=</span> <span class="n">target_dist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neighbor_weight</span> <span class="o">=</span> <span class="n">neighbor_weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lim_neighbors</span> <span class="o">=</span> <span class="n">lim_neighbors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fish_max_speed</span> <span class="o">=</span> <span class="n">fish_max_speed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clock_freq</span> <span class="o">=</span> <span class="n">clock_freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">caudal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dorsal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pect_r</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pect_l</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_depth</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">d_center</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body_length</span> <span class="o">=</span> <span class="mi">130</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clock_speed</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">clock_freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clock</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_started</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span> <span class="o">=</span> <span class="s1">&#39;home&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Some information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info_clock</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Time stamp of the information, i.e., the clock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info_hops</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Number of hops until the information arrived</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_hop_count_clock</span> <span class="o">=</span> <span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">inf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hop_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hop_distance</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hop_count_initiator</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_hop_count_clock</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">leader_election_max_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_leader_election_clock</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="c1"># Stores messages to be sent out at the end of the clock cycle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Logger instance</span>
        <span class="c1"># with open(&#39;{}_{}.log&#39;.format(self.name, self.id), &#39;w&#39;) as f:</span>
        <span class="c1">#     f.truncate()</span>
        <span class="c1">#     f.write(&#39;TIME  ::  #NEIGHBORS  ::  INFO  ::  ({})\n&#39;.format(</span>
        <span class="c1">#         datetime.datetime.now())</span>
        <span class="c1">#     )</span>

<div class="viewcode-block" id="Fish.start"><a class="viewcode-back" href="../index.html#fish.Fish.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start the process</span>

<span class="sd">        This sets `is_started` to true and invokes `run()`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_started</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="Fish.stop"><a class="viewcode-back" href="../index.html#fish.Fish.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop the process</span>

<span class="sd">        This sets `is_started` to false.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_started</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Fish.log"><a class="viewcode-back" href="../index.html#fish.Fish.log">[docs]</a>    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">neighbors</span><span class="o">=</span><span class="nb">set</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;Log current state</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="s1">&#39;a+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">{:05}</span><span class="s1">    </span><span class="si">{:04}</span><span class="s1">    </span><span class="si">{}</span><span class="s1">    </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">clock</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">neighbors</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">info_hops</span>
                <span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="Fish.run"><a class="viewcode-back" href="../index.html#fish.Fish.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the process recursively</span>

<span class="sd">        This method simulates the fish and calls `eval` on every clock tick as</span>
<span class="sd">        long as the fish `is_started`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_started</span><span class="p">:</span>

            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

            <span class="n">sleep_time</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clock_speed</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">time_elapsed</span>

            <span class="c1"># print(time_elapsed, sleep_time, self.clock_speed / 2)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sleep_time</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">sleep_time</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning frequency too high or computer too slow&#39;</span><span class="p">)</span>

            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

            <span class="n">sleep_time</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clock_speed</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">time_elapsed</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sleep_time</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">sleep_time</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning frequency too high or computer too slow&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Fish.move_handler"><a class="viewcode-back" href="../index.html#fish.Fish.move_handler">[docs]</a>    <span class="k">def</span> <span class="nf">move_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle move events, i.e., update the target position.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            event (Move): Event holding an x, y, and z target position</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">z</span></div>

<div class="viewcode-block" id="Fish.ping_handler"><a class="viewcode-back" href="../index.html#fish.Fish.ping_handler">[docs]</a>    <span class="k">def</span> <span class="nf">ping_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">,</span> <span class="n">rel_pos</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle ping events</span>

<span class="sd">        Arguments:</span>
<span class="sd">            neighbors {set} -- Set of active neighbors, i.e., nodes from which</span>
<span class="sd">                this fish received a ping event.</span>
<span class="sd">            rel_pos {dict} -- Dictionary of relative positions from this fish</span>
<span class="sd">                to the source of the ping event.</span>
<span class="sd">            event {Ping} -- The ping event instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">neighbors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">source_id</span><span class="p">)</span>

        <span class="c1"># When the other fish is not perceived its relative position is [0,0]</span>
        <span class="n">rel_pos</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">source_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">perceive_pos</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">source_id</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fish #</span><span class="si">{}</span><span class="s1">: saw friend #</span><span class="si">{}</span><span class="s1"> at </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">source_id</span><span class="p">,</span> <span class="n">rel_pos</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">source_id</span><span class="p">]</span>
            <span class="p">))</span></div>

<div class="viewcode-block" id="Fish.homing_handler"><a class="viewcode-back" href="../index.html#fish.Fish.homing_handler">[docs]</a>    <span class="k">def</span> <span class="nf">homing_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Homing handler, i.e., make fish aggregated extremely</span>

<span class="sd">        Arguments:</span>
<span class="sd">            event {Homing} -- Homing event</span>
<span class="sd">            pos {np.array} -- Position of the homing event initialtor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;signal_aircraft&#39;</span>  <span class="c1"># Very bad practice. Needs to be fixed!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info_clock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clock</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">InfoInternal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="c1"># update behavior based on external event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;wait&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">perceive_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fish #</span><span class="si">{}</span><span class="s1"> got external info </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">message</span>
            <span class="p">))</span></div>

<div class="viewcode-block" id="Fish.info_ext_handler"><a class="viewcode-back" href="../index.html#fish.Fish.info_ext_handler">[docs]</a>    <span class="k">def</span> <span class="nf">info_ext_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;External information handler</span>

<span class="sd">        Always accept the external information and spread the news.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            event {InfoExternal} -- InfoExternal event</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info_clock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clock</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">InfoInternal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fish #</span><span class="si">{}</span><span class="s1"> got external info </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">message</span>
            <span class="p">))</span></div>

<div class="viewcode-block" id="Fish.info_int_handler"><a class="viewcode-back" href="../index.html#fish.Fish.info_int_handler">[docs]</a>    <span class="k">def</span> <span class="nf">info_int_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal information event handler.</span>

<span class="sd">        Only accept the information of the clock is higher than from the last</span>
<span class="sd">        information</span>

<span class="sd">        Arguments:</span>
<span class="sd">            event {InfoInternal} -- Internal information event instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info_clock</span> <span class="o">&gt;=</span> <span class="n">event</span><span class="o">.</span><span class="n">clock</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info_clock</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">clock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info_hops</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">hops</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">InfoInternal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info_clock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info_hops</span><span class="p">)</span>
        <span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fish #</span><span class="si">{}</span><span class="s1"> got info: </span><span class="si">{}</span><span class="s1"> from #</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">source_id</span>
            <span class="p">))</span></div>

<div class="viewcode-block" id="Fish.hop_count_handler"><a class="viewcode-back" href="../index.html#fish.Fish.hop_count_handler">[docs]</a>    <span class="k">def</span> <span class="nf">hop_count_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Hop count handler</span>

<span class="sd">        Initialize only of the last hop count event is 4 clocks old. Otherwise</span>
<span class="sd">        update the hop count and resend the new value only if its larger than</span>
<span class="sd">        the previous hop count value.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            event {HopCount} -- Hop count event instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialize</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clock</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_hop_count_clock</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hop_count_initiator</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hop_distance</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">hops</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hop_count</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">hops</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">HopCount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info_clock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hop_count</span><span class="p">)</span>
            <span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># propagate value</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hop_count</span> <span class="o">&lt;</span> <span class="n">event</span><span class="o">.</span><span class="n">hops</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hop_count</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">hops</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hop_count_initiator</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                        <span class="bp">self</span><span class="p">,</span>
                        <span class="n">HopCount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info_clock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hop_count</span><span class="p">)</span>
                    <span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_hop_count_clock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clock</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fish #</span><span class="si">{}</span><span class="s1"> counts hops </span><span class="si">{}</span><span class="s1"> from #</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">hop_count</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">source_id</span>
            <span class="p">))</span></div>

<div class="viewcode-block" id="Fish.start_hop_count_handler"><a class="viewcode-back" href="../index.html#fish.Fish.start_hop_count_handler">[docs]</a>    <span class="k">def</span> <span class="nf">start_hop_count_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Hop count start handler</span>

<span class="sd">        Always accept a new start event for a hop count</span>

<span class="sd">        Arguments:</span>
<span class="sd">            event {StartHopCount} -- Hop count start event</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_hop_count_clock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hop_distance</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hop_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hop_count_initiator</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_hop_count_clock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clock</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">HopCount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info_clock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hop_count</span><span class="p">)</span>
        <span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fish #</span><span class="si">{}</span><span class="s1"> counts hops </span><span class="si">{}</span><span class="s1"> from #</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">hop_count</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">source_id</span>
            <span class="p">))</span></div>

<div class="viewcode-block" id="Fish.leader_election_handler"><a class="viewcode-back" href="../index.html#fish.Fish.leader_election_handler">[docs]</a>    <span class="k">def</span> <span class="nf">leader_election_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Leader election handler</span>

<span class="sd">        Arguments:</span>
<span class="sd">            event {LeaderElection} -- Leader election event instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This need to be adjusted in the future</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clock</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_leader_election_clock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
            <span class="n">new_max_id</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">max_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="c1"># propagate value</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">leader_election_max_id</span> <span class="o">&lt;</span> <span class="n">new_max_id</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">leader_election_max_id</span> <span class="o">=</span> <span class="n">new_max_id</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">LeaderElection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">new_max_id</span><span class="p">)</span>
                <span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_leader_election_clock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clock</span></div>

<div class="viewcode-block" id="Fish.weight_neighbor"><a class="viewcode-back" href="../index.html#fish.Fish.weight_neighbor">[docs]</a>    <span class="k">def</span> <span class="nf">weight_neighbor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_pos_to_neighbor</span><span class="p">):</span> <span class="c1">#xx obsolete with lj-pot?</span>
        <span class="sd">&quot;&quot;&quot;Weight neighbors by the relative position to them</span>

<span class="sd">        Currently only returns a static value but this could be tweaked in the</span>
<span class="sd">        future to calculate a weighted center point.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            rel_pos_to_neighbor {np.array} -- Relative position to a neighbor</span>

<span class="sd">        Returns:</span>
<span class="sd">            float -- Weight for this neighbor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbor_weight</span></div>

<div class="viewcode-block" id="Fish.start_leader_election_handler"><a class="viewcode-back" href="../index.html#fish.Fish.start_leader_election_handler">[docs]</a>    <span class="k">def</span> <span class="nf">start_leader_election_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Leader election start handler</span>

<span class="sd">        Always accept a new start event for a leader election</span>

<span class="sd">        Arguments:</span>
<span class="sd">            event {StartLeaderElection} -- Leader election start event</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_leader_election_clock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leader_election_max_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">LeaderElection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="p">))</span></div>

<div class="viewcode-block" id="Fish.comp_center"><a class="viewcode-back" href="../index.html#fish.Fish.comp_center">[docs]</a>    <span class="k">def</span> <span class="nf">comp_center</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_pos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the (potentially weighted) centroid of the fish neighbors</span>

<span class="sd">        Arguments:</span>
<span class="sd">            rel_pos {dict} -- Dictionary of relative positions to the</span>
<span class="sd">                neighboring fish.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.array -- 3D centroid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,))</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rel_pos</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">rel_pos</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_neighbor</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">center</span> <span class="o">+=</span> <span class="n">value</span> <span class="o">*</span> <span class="n">weight</span>

        <span class="n">center</span> <span class="o">/=</span> <span class="n">n</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fish #</span><span class="si">{}</span><span class="s1">: swarm centroid </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">center</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">center</span></div>

<div class="viewcode-block" id="Fish.lj_force"><a class="viewcode-back" href="../index.html#fish.Fish.lj_force">[docs]</a>    <span class="k">def</span> <span class="nf">lj_force</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">,</span> <span class="n">rel_pos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;lj_force derives the Lennard-Jones potential and force based on the relative positions of all neighbors and the desired self.target_dist to neighbors. The force is a gain factor, attracting or repelling a fish from a neighbor. The center is a point in space toward which the fish will move, based on the sum of all weighted neighbor positions.</span>

<span class="sd">        Args:</span>
<span class="sd">            neighbors (set): Visible neighbors</span>
<span class="sd">            rel_pos (dict): Relative positions of visible neighbors</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.array: Weighted 3D direction based on visible neighbors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">neighbors</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,))</span>

        <span class="n">a</span> <span class="o">=</span> <span class="mi">12</span> <span class="c1"># 12</span>
        <span class="n">b</span> <span class="o">=</span> <span class="mi">6</span> <span class="c1"># 6</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># depth of potential well, V_LJ(r_target) = epsilon</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># force gain</span>
        <span class="n">r_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_dist</span>
        <span class="n">r_const</span> <span class="o">=</span> <span class="n">r_target</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">body_length</span>

        <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,))</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbors</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">neighbor</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">rel_pos</span><span class="p">[</span><span class="n">neighbor</span><span class="p">]),</span> <span class="mf">0.001</span><span class="p">,</span> <span class="n">r_const</span><span class="p">)</span>
            <span class="n">f_lj</span> <span class="o">=</span> <span class="o">-</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">epsilon</span> <span class="o">/</span><span class="n">r</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">r_target</span> <span class="o">/</span> <span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="n">a</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="p">(</span><span class="n">r_target</span> <span class="o">/</span> <span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="n">b</span><span class="p">)</span>
            <span class="n">center</span> <span class="o">+=</span> <span class="n">f_lj</span> <span class="o">*</span> <span class="n">rel_pos</span><span class="p">[</span><span class="n">neighbor</span><span class="p">]</span>

        <span class="n">center</span> <span class="o">/=</span> <span class="n">n</span>

        <span class="k">return</span> <span class="n">center</span></div>

<div class="viewcode-block" id="Fish.depth_ctrl"><a class="viewcode-back" href="../index.html#fish.Fish.depth_ctrl">[docs]</a>    <span class="k">def</span> <span class="nf">depth_ctrl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r_move_g</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Controls diving depth based on direction of desired move.</span>

<span class="sd">        Args:</span>
<span class="sd">            r_move_g (np.array): Relative position of desired goal location in robot frame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pitch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">r_move_g</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">r_move_g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">r_move_g</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span>

        <span class="k">if</span> <span class="n">pitch</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dorsal</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">pitch</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dorsal</span> <span class="o">=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Fish.depth_waltz"><a class="viewcode-back" href="../index.html#fish.Fish.depth_waltz">[docs]</a>    <span class="k">def</span> <span class="nf">depth_waltz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r_move_g</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Controls diving depth in a pressure sensor fashion. Own depth is &quot;measured&quot;, i.e. reveiled by the interaction. Depth control is then done based on a target depth coming from a desired goal location in the robot frame.</span>

<span class="sd">        Args:</span>
<span class="sd">            r_move_g (np.array): Relative position of desired goal location in robot frame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">perceive_depth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_depth</span> <span class="o">=</span> <span class="n">depth</span> <span class="o">+</span> <span class="n">r_move_g</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_depth</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dorsal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dorsal</span> <span class="o">=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="Fish.home"><a class="viewcode-back" href="../index.html#fish.Fish.home">[docs]</a>    <span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r_move_g</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Homing behavior. Sets fin controls to move toward a desired goal location.</span>

<span class="sd">        Args:</span>
<span class="sd">            r_move_g (np.array): Relative position of desired goal location in robot frame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">caudal_range</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1"># abs(heading) below which caudal fin is switched on</span>

        <span class="n">heading</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">r_move_g</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r_move_g</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span>

        <span class="c1"># target to the right</span>
        <span class="k">if</span> <span class="n">heading</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pect_l</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.6</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">heading</span><span class="p">)</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pect_r</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">heading</span> <span class="o">&lt;</span> <span class="n">caudal_range</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">caudal</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">r_move_g</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">body_length</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">caudal</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># target to the left</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pect_r</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.6</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">heading</span><span class="p">)</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pect_l</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">heading</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">caudal_range</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">caudal</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">r_move_g</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">body_length</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">caudal</span> <span class="o">=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Fish.collisions"><a class="viewcode-back" href="../index.html#fish.Fish.collisions">[docs]</a>    <span class="k">def</span> <span class="nf">collisions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r_move_g</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Local collision avoidance where r_move_g comes from a local Lennard-Jones potential.</span>

<span class="sd">        Args:</span>
<span class="sd">            r_move_g (np.array): Relative position of desired goal location in robot frame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">caudal_range</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1"># abs(heading) below which caudal fin is switched on</span>

        <span class="n">heading</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">r_move_g</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r_move_g</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span>

        <span class="c1"># target to the right</span>
        <span class="k">if</span> <span class="n">heading</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pect_l</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.6</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">heading</span><span class="p">)</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">heading</span> <span class="o">&lt;</span> <span class="n">caudal_range</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">caudal</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caudal</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">caudal</span><span class="o">+</span><span class="mf">0.2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">r_move_g</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">body_length</span><span class="p">))</span>

        <span class="c1"># target to the left</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pect_r</span> <span class="o">+=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.6</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">heading</span><span class="p">)</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">heading</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">caudal_range</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">caudal</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caudal</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">caudal</span><span class="o">+</span><span class="mf">0.2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">r_move_g</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">body_length</span><span class="p">))</span></div>

<div class="viewcode-block" id="Fish.transition"><a class="viewcode-back" href="../index.html#fish.Fish.transition">[docs]</a>    <span class="k">def</span> <span class="nf">transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r_move_g</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transitions between homing and orbiting. Uses pectoral right fin to align tangentially with the orbit.</span>

<span class="sd">        Args:</span>
<span class="sd">            r_move_g (np.array): Relative position of desired goal location in robot frame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caudal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pect_l</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pect_r</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">heading</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">r_move_g</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r_move_g</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span>

        <span class="k">if</span> <span class="n">heading</span> <span class="o">&gt;</span> <span class="mi">35</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pect_r</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span> <span class="o">=</span> <span class="s1">&#39;orbit&#39;</span></div>

<div class="viewcode-block" id="Fish.orbit"><a class="viewcode-back" href="../index.html#fish.Fish.orbit">[docs]</a>    <span class="k">def</span> <span class="nf">orbit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r_move_g</span><span class="p">,</span> <span class="n">target_dist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Orbits an object, e.g. two vertically stacked LEDs, at a predefined radius</span>

<span class="sd">        Uses four zones to control the orbit with pectoral and caudal fins. The problem is reduced to 2D and depth control is handled separately.</span>
<span class="sd">        Could make fin frequencies dependent on distance and heading, i.e., use proportianl control.</span>

<span class="sd">        Args:</span>
<span class="sd">            r_move_g (np.array): Relative position of desired goal location in robot frame.</span>
<span class="sd">            target_dist (int): Target orbiting radius, [mm]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">r_move_g</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span> <span class="c1"># 2D, ignoring z</span>
        <span class="n">heading</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">r_move_g</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r_move_g</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span>

        <span class="k">if</span> <span class="n">dist</span> <span class="o">&gt;</span> <span class="n">target_dist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">heading</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">caudal</span> <span class="o">=</span> <span class="mf">0.45</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pect_l</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pect_r</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">caudal</span> <span class="o">=</span> <span class="mf">0.3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pect_l</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pect_r</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">heading</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">caudal</span> <span class="o">=</span> <span class="mf">0.45</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pect_l</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pect_r</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">caudal</span> <span class="o">=</span> <span class="mf">0.45</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pect_l</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pect_r</span> <span class="o">=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Fish.move"><a class="viewcode-back" href="../index.html#fish.Fish.move">[docs]</a>    <span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">,</span> <span class="n">rel_pos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a cohesion and target-driven move</span>

<span class="sd">        The move is determined by the relative position of the centroid and a</span>
<span class="sd">        target position and is limited by the maximum fish speed.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            neighbors (TYPE): Description</span>
<span class="sd">            rel_pos (TYPE): Description</span>
<span class="sd">            neighbors {set} -- Set of active neighbors, i.e., other fish that</span>
<span class="sd">                responded to the most recent ping event.</span>
<span class="sd">            rel_pos {dict} -- Relative positions to all neighbors</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.array -- Move direction as a 3D vector</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get the centroid of the swarm</span>
        <span class="n">centroid_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,))</span>

        <span class="c1"># Get the relative direction to the centroid of the swarm</span>
        <span class="c1">#centroid_pos = self.lj_force(neighbors, rel_pos)</span>
        <span class="c1">#self.d_center = np.linalg.norm(self.comp_center(rel_pos))</span>

        <span class="n">move</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_pos</span><span class="c1"># + centroid_pos</span>

        <span class="c1"># Global to Robot Transformation</span>
        <span class="n">r_T_g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">rot_global_to_robot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">r_move_g</span> <span class="o">=</span> <span class="n">r_T_g</span> <span class="o">@</span> <span class="n">move</span>

        <span class="c1">#obstacle_avoidance = r_T_g @ centroid_pos</span>

        <span class="c1"># Simulate dynamics and restrict movement #xx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth_ctrl</span><span class="p">(</span><span class="n">r_move_g</span><span class="p">)</span>
        <span class="c1">#self.depth_waltz(r_move_g)</span>
        <span class="c1">#self.home(r_move_g)</span>

        <span class="c1"># Orbiting</span>
        <span class="c1">#################################################</span>
        <span class="n">target_dist</span> <span class="o">=</span> <span class="mi">400</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span> <span class="o">==</span> <span class="s1">&#39;home&#39;</span><span class="p">:</span>
            <span class="n">dist_filtered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">r_move_g</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dist_filtered</span> <span class="o">&lt;</span> <span class="n">target_dist</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span> <span class="o">=</span> <span class="s1">&#39;transition&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">home</span><span class="p">(</span><span class="n">r_move_g</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span> <span class="o">==</span> <span class="s1">&#39;transition&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transition</span><span class="p">(</span><span class="n">r_move_g</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span> <span class="o">==</span> <span class="s1">&#39;orbit&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orbit</span><span class="p">(</span><span class="n">r_move_g</span><span class="p">,</span> <span class="n">target_dist</span><span class="p">)</span>
        <span class="c1"># Orbiting</span>
        <span class="c1">#################################################</span>

        <span class="c1">#self.collisions(obstacle_avoidance)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="o">.</span><span class="n">update_ctrl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dorsal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">caudal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pect_r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pect_l</span><span class="p">)</span>
        <span class="n">final_move</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="o">.</span><span class="n">simulate_move</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># Cap the length of the move (OLD SIMULATOR)</span>
        <span class="c1"># magnitude = np.linalg.norm(move)</span>
        <span class="c1"># if magnitude &gt; 0:</span>
        <span class="c1">#     direction = move / magnitude</span>
        <span class="c1">#     final_move = direction * min(magnitude, self.fish_max_speed)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     final_move = move</span>

        <span class="c1"># if self.verbose:</span>
        <span class="c1">#     print(&#39;Fish #{}: move to {}&#39;.format(self.id, final_move))</span>

        <span class="c1">#print(final_move)</span>
        <span class="k">return</span> <span class="n">final_move</span></div>

<div class="viewcode-block" id="Fish.update_behavior"><a class="viewcode-back" href="../index.html#fish.Fish.update_behavior">[docs]</a>    <span class="k">def</span> <span class="nf">update_behavior</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the fish behavior.</span>

<span class="sd">        This actively changes the cohesion strategy to either &#39;wait&#39;, i.e, do</span>
<span class="sd">        not care about any neighbors or &#39;signal_aircraft&#39;, i.e., aggregate with</span>
<span class="sd">        as many fish friends as possible.</span>

<span class="sd">        In robotics &#39;signal_aircraft&#39; is a secret key word for robo-fish-nerds</span>
<span class="sd">        to gather in a secret lab until some robo fish finds a robo aircraft.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;wait&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lim_neighbors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">==</span> <span class="s1">&#39;signal_aircraft&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lim_neighbors</span> <span class="o">=</span> <span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span></div>

<div class="viewcode-block" id="Fish.eval"><a class="viewcode-back" href="../index.html#fish.Fish.eval">[docs]</a>    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The fish evaluates its state</span>

<span class="sd">        Currently the fish checks all responses to previous pings and evaluates</span>
<span class="sd">        its relative position to all neighbors. Neighbors are other fish that</span>
<span class="sd">        received the ping element.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Set of neighbors at this point. Will be reconstructed every time</span>
        <span class="n">neighbors</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">rel_pos</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">saw_hop_count</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">PING</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ping_handler</span><span class="p">(</span><span class="n">neighbors</span><span class="p">,</span> <span class="n">rel_pos</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">HOMING</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">homing_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">START_HOP_COUNT</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">start_hop_count_handler</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">HOP_COUNT</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hop_count_handler</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">INFO_EXTERNAL</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">info_ext_handler</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">INFO_INTERNAL</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">info_int_handler</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">START_LEADER_ELECTION</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">start_leader_election_handler</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LEADER_ELECTION</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">leader_election_handler</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">MOVE</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">move_handler</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clock</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Move around (or just stay where you are)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">blind_spot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">,</span> <span class="n">rel_pos</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">occlude</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">,</span> <span class="n">rel_pos</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">neighbors</span><span class="p">,</span> <span class="n">rel_pos</span><span class="p">))</span>

        <span class="c1"># Update behavior based on status and information - update behavior</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_behavior</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span> <span class="o">=</span> <span class="n">neighbors</span>

        <span class="c1"># self.log(neighbors)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clock</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="Fish.communicate"><a class="viewcode-back" href="../index.html#fish.Fish.communicate">[docs]</a>    <span class="k">def</span> <span class="nf">communicate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Broadcast all collected event messages.</span>

<span class="sd">        This method is called as part of the second clock cycle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">transmit</span><span class="p">(</span><span class="o">*</span><span class="n">message</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Always send out a ping to other fish</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">transmit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Ping</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">BlueSim 0.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Florian Berlinger.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.2.
    </div>
  </body>
</html>